---
title: "Impacto de la  diabetes mellitus en personas hospitalizadas por COVID19"
author: "Rai Puig & Jordi Real"
website: "https://github.com/USR-DAPCAT/"

date: "`r format(Sys.time(), '%d %B, %Y')`"


output:
  html_document:
    df_print: paged
    toc: true
    toc_float: true
    fig_caption: true
    css: logos_css/usr_styles.css
  pdf_document: default
  word_document: default

params:
  dir_dades: "dades/mostra"
  
---

&nbsp;
<script>
   $(document).ready(function() {
     $head = $('#header');
     $head.prepend('<img src=\"https://www.idiapjgol.org/images/logo.png\" style=\"float: right ;width: 130px;\"/>')
     $head.prepend('<img src=\"https://avatars2.githubusercontent.com/u/57066591?s=200&v=4\" style=\"margin-left:25% ;width: 80px;\"/>')
     $head.prepend('<img src=\"logoDAP_Cat.png\" style=\"float: left:1;width: 185px;\"/>')
   });
</script>



<div class="watermark">DRAFT</div>


****


# FASE LECTURA

>> Generació de taula plana i aplicació de primers criteris d'inclusió 


```{r setup, include = FALSE}

#18.09.2020#

library("dplyr")
library("lubridate")
library("expss")
library("frequency")
library("sjPlot")
library("sjmisc")
library("sjlabelled")

# Funcions 
link_source<-paste0("https://github.com/jrealgatius/Stat_codis/blob/master/funcions_propies.R","?raw=T")
devtools::source_url(link_source)
dir_dades<-"dades"

directori_dades<-params$dir_dades

directori_dades<-dir_dades

conductor_codis2<-here::here("Codis_Covid_Agrupadores_juny")


#   template: template.html
```


## 1. Lectura 

```{r lectura}

# 1 Lectura -----------

#-------------------------------------------------------------------------#
#i)     En la tabla principal, están los datos propios del ingreso y del paciente (edad y sexo),
#       los datos de la urgencia previa si ha habido (2.226 registros), su estancia en UCI, 
#       si ha habido y los registros del primer y último conjunto de constantes de la urgencia 
dt_01<-read.csv2(here::here(directori_dades,"01.csv"),sep=";",dec=",",header = TRUE)%>% as_tibble()
#-------------------------------------------------------------------------#
#ii)    En la tabla de medicación, se encuentra toda la medicación administrada 
#       a cada paciente durante su ingreso (más de 60.000 registros), 
#       con las fechas correspondientes a la primera y última administración de cada fármaco identificaos estos,
#       por su nombre comercial y su clasificación en la ATC5/ATC7. 
dt_02<-read.csv2(here::here(directori_dades,"02.csv"),sep=";",dec=",",header = TRUE) %>% as_tibble()
#-------------------------------------------------------------------------#
#iii)   En la tabla de constantes vitales, 
#       se encuentran todos los registros de constantes (54.000 registros hasta el momento)
#       básicas recogidos durante su ingreso con su fecha y hora de registro. 
dt_03<-read.csv2(here::here(directori_dades,"03.csv"),sep=";",dec=",",header = TRUE) %>% as_tibble()
#-------------------------------------------------------------------------#
#iv)    En la tabla de laboratorio se encuentran los resultados de las determinaciones (398.884 registros)
#       de todas las peticiones realizadas a cada paciente durante su ingreso y 
#       en la urgencia previa, si hubiera tenido. 
dt_04<-read.csv2(here::here(directori_dades,"04.csv"),sep=";",dec=",",header = TRUE) %>% as_tibble()
# dt_04 <- readr::read_delim(here::here(directori_dades,"04.csv"), ";", escape_double = FALSE, trim_ws = TRUE) %>% as_tibble()
#-------------------------------------------------------------------------#
#v)vi) 
#       Y por último en las tablas de codificación CIE10, 
#       aparecen los registros de la información de diagnósticos y procedimientos
#       codificada según la clasificación internacional CIE10 en su última versión distribuida 
#       (no contempla COVID), tanto para los episodios de ingresados (más de 1.600) de los pacientes
#       referidos como de las urgencias (más de 1.900) 
#       previas a esos episodios si las hubiera habido
dt_05<-read.csv2(here::here(directori_dades,"05.csv"),sep=";",dec=",",header = TRUE) %>% as_tibble()
dt_06<-read.csv2(here::here(directori_dades,"06.csv"),sep=";",dec=",",header = TRUE) %>% as_tibble()
#-------------------------------------------------------------------------#  

conductor<-"conductor_Covid.xlsx"
conductor_codis2<-here::here("codis_Covid_Agrupadores_juny.xlsx")

dt_cataleg2<-readxl::read_excel(conductor_codis2,col_types = "text")%>%select(cod,agr,agr2,agr3,agr4,agr5,agr6,agr7)


#source('codi/funcions_Covid.r')
```
## 2. Agregacio de dades
```{r agregacio1}
source(here::here("codi/funcions_Covid.r"))

###############################################
# dt_plana_COVID1 (TaulaPLANA1  Principal!!!) #
###############################################
dt_plana_covid1<-dt_01

#9.5.2020
#0)
dt_plana_covid1$year_ingres<-as.numeric(substr(dt_plana_covid1$F_INGRESO.ADMISSION_D_ING.INPAT,7,10))
dt_plana_covid1$year_urg<-as.numeric(substr(dt_plana_covid1$F_INGRESO.ADMISSION_DATE_URG.EMERG,7,10))


#i)
dt_plana_covid1$F_INGRESO.ADMISSION_D_ING.INPAT<-lubridate::dmy(dt_plana_covid1$F_INGRESO.ADMISSION_D_ING.INPAT)
#ii)
dt_plana_covid1$F_ENTRADA_UC.ICU_DATE_IN<-substr(dt_plana_covid1$F_ENTRADA_UC.ICU_DATE_IN,1,10)
dt_plana_covid1$F_ENTRADA_UC.ICU_DATE_IN<-as.Date(dt_plana_covid1$F_ENTRADA_UC.ICU_DATE_IN,"%d/%m/%Y")
#iii)
dt_plana_covid1$F_SALIDA_UCI.ICU_DATE_OUT<-substr(dt_plana_covid1$F_SALIDA_UCI.ICU_DATE_OUT,1,10)
dt_plana_covid1$F_SALIDA_UCI.ICU_DATE_OUT<-as.Date(dt_plana_covid1$F_SALIDA_UCI.ICU_DATE_OUT,"%d/%m/%Y")
#iv)
dt_plana_covid1$F_ALTA.DISCHARGE_DATE_ING<-lubridate::dmy(dt_plana_covid1$F_ALTA.DISCHARGE_DATE_ING)
#v)
dt_plana_covid1$F_INGRESO.ADMISSION_DATE_URG.EMERG<-lubridate::dmy(dt_plana_covid1$F_INGRESO.ADMISSION_DATE_URG.EMERG)  
#
#
dt_plana_covid1<-dt_plana_covid1%>% mutate(URG=ifelse(is.na(F_INGRESO.ADMISSION_DATE_URG.EMERG ),0,1))
dt_plana_covid1<-dt_plana_covid1%>% mutate(URG=ifelse(URG==0,"No","Si")) 
#

pacient19<-dt_plana_covid1%>%filter(year_ingres==2019)%>%select(PATIENT.ID)
#

############################################################################
# eps, 8.5.2020 : Pacients amb data d'ingrés /UCI.2019 s'han de filtrar!
# A tibble: 1 x 1
#PATIENT.ID
#<int>
#  1        577
############################################################################
#variable.names(dt_plana_covid1)
#
#
#
#
#TEMP_PRIMERA.FIRST_URG.EMERG
#FC.HR_PRIMERA.FIRST_URG.EMERG
#GLU_PRIMERA.FIRST_URG.EMERG
#SAT_02_PRIMERA.FIRST_URG.EMERG
#TA_MAX_PRIMERA.FIRST.EMERG_URG
#TA_MIN_PRIMERA.FIRST_URG.EMERG

#TEMP_ULTIMA.LAST_URG.EMERG
#FC.HR_ULTIMA.LAST_URG.EMERG
#GLU_ULTIMA.LAST_URG.EMERG
#SAT_02_ULTIMA.LAST_URG.EMERG
#TA_MAX_ULTIMA.LAST_URGEMERG
#TA_MIN_ULTIMA.LAST_URG.EMERG
```


```{r agregacio2}
# 5.8.2020 !
# Los que tienen 0.00 se tienen que contar como missings,TEMP_PRIMERA.FIRST_URG.EMERG.......ETC


dt_plana_covid1<-dt_plana_covid1%>%
  mutate(TEMP_PRIMERA.FIRST_URG.EMERG = ifelse(TEMP_PRIMERA.FIRST_URG.EMERG==0,NA, TEMP_PRIMERA.FIRST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(FC.HR_PRIMERA.FIRST_URG.EMERG = ifelse(FC.HR_PRIMERA.FIRST_URG.EMERG==0,NA, FC.HR_PRIMERA.FIRST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(GLU_PRIMERA.FIRST_URG.EMERG = ifelse(GLU_PRIMERA.FIRST_URG.EMERG==0,NA, GLU_PRIMERA.FIRST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(SAT_02_PRIMERA.FIRST_URG.EMERG = ifelse(SAT_02_PRIMERA.FIRST_URG.EMERG==0,NA, SAT_02_PRIMERA.FIRST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(TA_MAX_PRIMERA.FIRST.EMERG_URG = ifelse(TA_MAX_PRIMERA.FIRST.EMERG_URG==0,NA, TA_MAX_PRIMERA.FIRST.EMERG_URG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(TA_MIN_PRIMERA.FIRST_URG.EMERG = ifelse(TA_MIN_PRIMERA.FIRST_URG.EMERG==0,NA, TA_MIN_PRIMERA.FIRST_URG.EMERG))



dt_plana_covid1<-dt_plana_covid1%>%
  mutate(TEMP_ULTIMA.LAST_URG.EMERG= ifelse(TEMP_ULTIMA.LAST_URG.EMERG==0,NA, TEMP_ULTIMA.LAST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(FC.HR_ULTIMA.LAST_URG.EMERG = ifelse(FC.HR_ULTIMA.LAST_URG.EMERG==0,NA, FC.HR_ULTIMA.LAST_URG.EMERG))


dt_plana_covid1<-dt_plana_covid1%>%
  mutate(GLU_ULTIMA.LAST_URG.EMERG = ifelse(GLU_ULTIMA.LAST_URG.EMERG==0,NA, GLU_ULTIMA.LAST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(SAT_02_ULTIMA.LAST_URG.EMERG = ifelse(SAT_02_ULTIMA.LAST_URG.EMERG==0,NA, SAT_02_ULTIMA.LAST_URG.EMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(TA_MAX_ULTIMA.LAST_URGEMERG = ifelse(TA_MAX_ULTIMA.LAST_URGEMERG==0,NA, TA_MAX_ULTIMA.LAST_URGEMERG))

dt_plana_covid1<-dt_plana_covid1%>%
  mutate(TA_MIN_ULTIMA.LAST_URG.EMERG = ifelse(TA_MIN_ULTIMA.LAST_URG.EMERG==0,NA, TA_MIN_ULTIMA.LAST_URG.EMERG))

dt_plana_covid1_agr<-dt_plana_covid1
dt_plana_covid1_org<-dt_plana_covid1


# A tibble: 2,307 x 29
```


```{r agregacio3}
###############################################
##[T2]##.Farmacs.Mètode:Aggregador.
###############################################

#dt_plana_covid2
dt_plana_covid2<-dt_02

dt_plana_covid2B<-dt_plana_covid2%>% transmute(idp=PATIENT.ID,cod=as.character(ID_ATC7),dat="20200520") 

dt_plana_covid2_agr<-agregar_problemes(select(dt_plana_covid2B,idp,cod,dat),
                                       bd.dindex = "20000601",
                                       dt.agregadors=select(dt_cataleg2,cod,agr=agr3),
                                       finestra.dies=c(-Inf,Inf),prefix = "FX.") 
#dt_plana_covid2_agr
# A tibble: 2,301 x 74

# Canviar prefix de DG(Diagnostic) --> FP (Fàrmac prescrit)

dt_plana_covid2_agr_b<-agregar_problemes(select(dt_plana_covid2B,idp,cod,dat),
                                       bd.dindex = "20000601",
                                       dt.agregadors=select(dt_cataleg2,cod,agr=agr4),
                                       finestra.dies=c(-Inf,Inf),prefix = "FX.") 
#dt_plana_covid2_agr_b



################################################################################
# dt_plana_COVID2 (TaulaPLANA2.FARMACS) #
################################################################################
#dt_plana_covid2_agr
#dt_plana_covid2_agr_b
################################################################################
```


```{r agregacio4}
####################################################################
##[T3]##.Constants Vitals.Mètode:Preparció com Laboratori.Spread.
####################################################################


dt_plana_covid3<-dt_03

#i)
dt_plana_covid3_FC<-dt_plana_covid3%>%
  transmute(PATIENT.ID,dat=CONSTANTS_ING.INPAT_FECHA.DATE,valor=FC.HR_ING.INPAT,cod="FC.HR_ING.INPAT")
#ii)
dt_plana_covid3_GLU<-dt_plana_covid3%>%
  transmute(PATIENT.ID,dat=CONSTANTS_ING.INPAT_FECHA.DATE,valor=GLU.GLY_ING.INPAT,cod="GLU.GLY_ING.INPAT")
#iii)
dt_plana_covid3_SAT<-dt_plana_covid3%>%
  transmute(PATIENT.ID,dat=CONSTANTS_ING.INPAT_FECHA.DATE,valor=SAT_02_ING.INPAT,cod="SAT_02_ING.INPAT")
#iv)
dt_plana_covid3_TA_MAX<-dt_plana_covid3%>%
  transmute(PATIENT.ID,dat=CONSTANTS_ING.INPAT_FECHA.DATE,valor=TA_MAX_ING.INPAT,cod="TA_MAX_ING.INPAT")
#v)
dt_plana_covid3_TA_MIN<-dt_plana_covid3%>%
  transmute(PATIENT.ID,dat=CONSTANTS_ING.INPAT_FECHA.DATE,valor=TA_MIN_ING.INPAT,cod="TA_MIN_ING.INPAT")
#vi)
dt_plana_covid3_TEMP<-dt_plana_covid3%>%
  transmute(PATIENT.ID,dat=CONSTANTS_ING.INPAT_FECHA.DATE,valor=TEMP_ING.INPAT,cod="TEMP_ING.INPAT")
#----------------------------------------------------------------------------------------------------------------#
dt_plana_covid3_B<-dt_plana_covid3_FC%>% 
  bind_rows(dt_plana_covid3_GLU)%>%  
    bind_rows(dt_plana_covid3_SAT)%>% 
      bind_rows(dt_plana_covid3_TA_MAX)%>% 
        bind_rows(dt_plana_covid3_TA_MIN)%>% 
          bind_rows(dt_plana_covid3_TEMP)

dt_plana_covid3_B$valor<- as.double(dt_plana_covid3_B$valor)

# eps escollim els que no tinguin 0, ni .na!


dt_spread<-function(dt=dt_plana_covid3_B,codi="FC.HR_ING.INPAT") 
  {

  # dt=dt_plana_covid3_B
  # codi="GLU.GLY_ING.INPAT"
  
  dt<-dt%>% 
    filter(cod==codi)%>%
      filter(valor!=0)%>% filter(!is.na(valor)) %>% 
        group_by(PATIENT.ID)%>%
          arrange(dat)%>%
            mutate(n(),V=row_number()) %>% 
              ungroup() %>% 
                select(PATIENT.ID,V,valor)%>% 
                  arrange(PATIENT.ID,V)%>% 
                     spread("V","valor",sep=paste0("._.",codi)) 
  
  names(dt)<-names(dt) %>% stringr::str_replace("V._.","")
  
  dt

  }



#### EXEMPLE D'APLICAR LA FUNCIÓ MAP I REDUCE PER APLICAR UNA FUNCIÓ PER APLANAR
#llista_vars<-dt_plana_covid3_B %>% distinct(cod) %>% as_vector()

llista_vars<-c("FC.HR_ING.INPAT","TA_MAX_ING.INPAT","TA_MIN_ING.INPAT","TEMP_ING.INPAT")
dt_plana_covid3_agr <-
  llista_vars %>% 
  map(~dt_spread(dt_plana_covid3_B,.x)) %>% 
  reduce(full_join,by="PATIENT.ID")

analitiques.agr<-agregar_vars_covid(dt =dt_plana_covid3_B)

dt_plana_covid3_agr<-dt_plana_covid3_agr %>%
  left_join(analitiques.agr  ,by="PATIENT.ID")

```


```{r agregacio5}
####################################################################
##[T4]##.ANALITIQUES: Spread.
####################################################################



#
#1)   Determinación|TROPO -- TROPONINA
#2)   Determinación|TP -- TIEMPO DE PROTROMBINA
#3)   Determinación|TCO2V -- tCO2 (B)
#4)   Determinación|TCO2 -- tCO2(B)c
#5)   Determinación|SO2C -- sO2c (Saturación de oxígeno)
#6)   Determinación|PROCAL -- PROCALCITONINA
#7)   Determinación|PO2V -- pO2
#8)   Determinación|PO2 -- pO2
#9)   Determinación|PLAQ -- Recuento de plaquetas
#10)  Determinación|PCR -- PROTEINA C REACTIVA
#11)  Determinación|PCO2V -- pCO2
#12)  Determinación|PCO2 -- pCO2
#13)  Determinación|NEU% -- Neutrófilos %
#14)  Determinación|NEU -- Neutrófilos
#15)  Determinación|NA -- SODIO
#16)  Determinación|MONO% -- Monocitos %
#17)  Determinación|MONO -- Monocitos
#18)  Determinación|LIN% -- Linfocitos %
#19)  Determinación|LIN -- Linfocitos
#20)  Determinación|LEUC -- Leucocitos
#21)  Determinación|LDH -- LDH
#22)  Determinación|INR -- INR
#23)  Determinación|HGB -- Hemoglobina
#24)  Determinación|HBA1C -- HEMOGLOBINA GLICOSILADA  (HBA1C)
#25)  Determinación|GPT -- GPT (ALT)
#26)  Determinación|GOT -- GOT (AST)
#27)  Determinación|GLU -- GLUCOSA
#28)  Determinación|GGT -- GGT (GAMMA GLUTAMIL TRANSPEPTIDASA)
#29)  Determinación|G-CORONAV (RT-PCR) -- Tipo de muestra: EXUDADO
#30)  Determinación|FOS -- FOSFORO
#31)  Determinación|FA -- FOSFATASA ALCALINA
#32)  Determinación|DD -- DIMERO D
#33)  Determinación|CREA -- CREATININA
#34)  Determinación|CA++ -- Ca++ Gasometria
#35)  Determinación|CA -- CALCIO
#36)  Determinación|BT -- BILIRRUBINA TOTAL
#37)  CREA – CREATININA1
#38)  HDL – COLESTEROL HDL1
#39)  COL – COLESTEROL TOTAL1

#
#-----------------------------------------------------------------------------------------------#
dt_plana_covid4<-dt_04
#-----------------------------------------------------------------------------------#
dt_plana_covid4B<-dt_plana_covid4%>%select(PATIENT.ID,FECHA_PETICION.LAB_DATE,DETERMINACION.ITEM_LAB,RESULTADO.VAL_RESULT)%>%
  transmute(PATIENT.ID=PATIENT.ID,dat=FECHA_PETICION.LAB_DATE,valor=RESULTADO.VAL_RESULT,cod=DETERMINACION.ITEM_LAB)






```


```{r agregacio6}
#-----------------------------------------------------------------------------------------------#
KK<-str_split_fixed(dt_plana_covid4B$cod, "--",2)
dt_plana_covid4B<-cbind(dt_plana_covid4B,cod2=KK[,1])
#-----------------------------------------------------------------------------------------------#
dt_plana_covid4B$valor             <-as.character(dt_plana_covid4B$valor)

PATIENT.ID<- dt_plana_covid4B$PATIENT.ID
valor<- dt_plana_covid4B$valor
cod<-KK[,1]
dat<-dt_plana_covid4B$dat
cod2<-dt_plana_covid4B$cod

#-----------------------------------------------------------------------------------------------#
dt_cataleg_analitica4C<-cbind(PATIENT.ID,dat,valor,domini="variables_analitiques",cod,cod2)
variable.names(dt_cataleg_analitica4C)
#dt_cataleg_analitica4C
variable.names(dt_cataleg_analitica4C)
#"PATIENT.ID" "dat"        "valor"      "domini"     "cod"    
dt_cataleg_analitica4C<-dt_cataleg_analitica4C%>%as_tibble()%>%select(-domini)

dt_plana_covid4_agr<-dt_cataleg_analitica4C





```


```{r agregacio7}
#1)   Determinación|TROPO -- TROPONINA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="TROPO ","US_troponina_",dt_plana_covid4_agr$cod)

#2)   Determinación|TP -- TIEMPO DE PROTROMBINA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="TP ","TP_",dt_plana_covid4_agr$cod)
#3)   Determinación|TCO2V -- tCO2 (B)
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="TCO2V ","TCO2V_",dt_plana_covid4_agr$cod)
#4)   Determinación|TCO2 -- tCO2(B)c
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="TCO2 ","TCO2_",dt_plana_covid4_agr$cod)
#5)   Determinación|SO2C -- sO2c (Saturación de oxígeno)
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="SO2C ","SO2C_",dt_plana_covid4_agr$cod)
#6)   Determinación|PROCAL -- PROCALCITONINA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PROCAL ","PROCAL_",dt_plana_covid4_agr$cod)
#7)   Determinación|PO2V -- pO2
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PO2V ","PO2V_",dt_plana_covid4_agr$cod)
#8)   Determinación|PO2 -- pO2
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PO2 ","PO2_",dt_plana_covid4_agr$cod)
#9)   Determinación|PLAQ -- Recuento de plaquetas
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PLAQ ","PLAQ_",dt_plana_covid4_agr$cod)
#10)  Determinación|PCR -- PROTEINA C REACTIVA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PCR ","PCR_",dt_plana_covid4_agr$cod)
#11)  Determinación|PCO2V -- pCO2
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PCO2V ","PCO2V_",dt_plana_covid4_agr$cod)
#12)  Determinación|PCO2 -- pCO2
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="PCO2 ","PCO2_",dt_plana_covid4_agr$cod)
#13)  Determinación|NEU% -- Neutrófilos %
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="NEU% ","NEU_PER_",dt_plana_covid4_agr$cod)
#14)  Determinación|NEU -- Neutrófilos
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="NEU ","NEU_",dt_plana_covid4_agr$cod)
#15)  Determinación|NA -- SODIO
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="NA ","NA_",dt_plana_covid4_agr$cod)
#16)  Determinación|MONO% -- Monocitos %
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="MONO% ","MONO_PER_",dt_plana_covid4_agr$cod)
#17)  Determinación|MONO -- Monocitos
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="MONO ","MONO_",dt_plana_covid4_agr$cod)
#18)  Determinación|LIN% -- Linfocitos %
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="LIN% ","LIN_PER_",dt_plana_covid4_agr$cod)
#19)  Determinación|LIN -- Linfocitos
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="LIN ","LIN_",dt_plana_covid4_agr$cod)
#20)  Determinación|LEUC -- Leucocitos
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="LEUC ","LEUC_",dt_plana_covid4_agr$cod)
#21)  Determinación|LDH -- LDH
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="LDH ","LDH_",dt_plana_covid4_agr$cod)
#22)  Determinación|INR -- INR
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="INR ","INR_",dt_plana_covid4_agr$cod)
#23)  Determinación|HGB -- Hemoglobina
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="HGB ","HGB_",dt_plana_covid4_agr$cod)
#24)  Determinación|HBA1C -- HEMOGLOBINA GLICOSILADA  (HBA1C)
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="HBA1C ","HBA1C_",dt_plana_covid4_agr$cod)
#25)  Determinación|GPT -- GPT (ALT)
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="GPT ","GPT_",dt_plana_covid4_agr$cod)
#26)  Determinación|GOT -- GOT (AST)
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="GOT ","GOT_",dt_plana_covid4_agr$cod)
#27)  Determinación|GLU -- GLUCOSA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="GLU ","GLU_",dt_plana_covid4_agr$cod)
#28)  Determinación|GGT -- GGT (GAMMA GLUTAMIL TRANSPEPTIDASA)
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="GGT ","GGT_",dt_plana_covid4_agr$cod)
#29)  Determinación|G-CORONAV (RT-PCR) -- Tipo de muestra: EXUDADO
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="G-CORONAV (RT-PCR) ","G_CORONAV_",dt_plana_covid4_agr$cod)
#30)  Determinación|FOS -- FOSFORO
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="FOS ","FOS_",dt_plana_covid4_agr$cod)
#31)  Determinación|FA -- FOSFATASA ALCALINA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="FA ","FA_",dt_plana_covid4_agr$cod)
#32)  Determinación|DD -- DIMERO D
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="DD ","DD_",dt_plana_covid4_agr$cod)
 #33)  Determinación|CREA -- CREATININA
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="CREA ","CREA_",dt_plana_covid4_agr$cod)
#34)  Determinación|CA++ -- Ca++ Gasometria
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="CA++ ","CA2_",dt_plana_covid4_agr$cod)
#35)  Determinación|CA -- CALCIO
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="CA ","CA_",dt_plana_covid4_agr$cod)
#36)  Determinación|BT -- BILIRRUBINA TOTAL 
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="BT ","BT_",dt_plana_covid4_agr$cod)
#37)  HDL – COLESTEROL HDL1
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="HDL ","HDL_",dt_plana_covid4_agr$cod)
#38)  COL – COLESTEROL TOTAL1
dt_plana_covid4_agr$cod<-ifelse(dt_plana_covid4_agr$cod=="COL ","COL_",dt_plana_covid4_agr$cod)


dt_plana_covid4_agr_CORONA<-dt_plana_covid4_agr%>%filter(cod=="G_CORONAV_")%>%select(PATIENT.ID,valor,cod)
dt_plana_covid4_agr_CORONA<-dt_plana_covid4_agr_CORONA%>%filter(valor=="Se detecta")%>%
  group_by(PATIENT.ID) %>% dplyr::slice(1) %>% ungroup()  
dt_plana_covid4_agr_CORONA<-dt_plana_covid4_agr_CORONA%>%transmute( PATIENT.ID,CORONA=valor)

#table(dt_plana_covid4_agr_CORONA$PATIENT.ID)
```


```{r agregacio8}
#i)
dt_plana_covid4_agr_B<-dt_plana_covid4_agr%>%
  transmute(PATIENT.ID,dat=dat,valor=valor,cod=cod)%>%filter(cod=="US_troponina_" |
                                                             cod=="TP_"           |
                                                             cod=="TCO2V_"        |
                                                             cod=="TCO2_"         |
                                                             cod=="SO2C_"         |
                                                             cod=="PROCAL_"       |
                                                             cod=="PO2V_"         |
                                                             cod=="PO2_"          |
                                                             cod=="PLAQ_"         |
                                                             cod=="PCR_"          |
                                                             cod=="PCO2V_"        |
                                                             cod=="PCO2_"         |
                                                             cod=="NEU_PER_"      |
                                                             cod=="NEU_"          |
                                                             cod=="NA_"           |
                                                             cod=="MONO_PER_"     |
                                                             cod=="MONO_"         |
                                                             cod=="LIN_PER_"      |
                                                             cod=="LIN_"          |
                                                             cod=="LEUC_"         |
                                                             cod=="LDH_"          |
                                                             cod=="INR_"          |
                                                             cod=="HGB_"          |
                                                             cod=="HBA1C_"        |
                                                             cod=="GPT_"          |
                                                             cod=="GOT_"          |
                                                             cod=="GLU_"          |
                                                             cod=="GGT_"          |
                                                             cod=="FOS_"          |
                                                             cod=="FA_"           |
                                                             cod=="DD_"           |
                                                             cod=="CREA_"         |
                                                             cod=="CA2_"          |
                                                             cod=="CA_"           |
                                                             cod=="BT_"           |
                                                             cod=="HDL_"          |
                                                             cod=="COL_")
```


```{r agregacio9}
#1) # fer els missings!!!
dt_plana_covid4_agr_B$valor             <-as.double(dt_plana_covid4_agr_B$valor)
#
#COVID19_PCR                    
#COVID19_PCR_GRUP_ASP_BRONC 
#COVID19_PCR_GRUP_ASP_NASAL                          
#COVID19_PCR_GRUP_BAS 
#COVID19_PCR_GRUP_ESPUTO                       
#COVID19_PCR_GRUP_EXUADO 
#COVID19_PCR_GRUP_LCR                                         
# miirar demà 04.06.2020

vect2<- c(
  "US_troponina_",
  "TP_",
  "TCO2V_",
  "TCO2_",
  "SO2C_",
  "PROCAL_",
  "PO2V_",
  "PO2_",
  "PLAQ_",
  "PCR_",
  "PCO2V_",
  "PCO2_",
  "NEU_PER_",
  "NEU_",
  "NA_",
  "MONO_PER_",
  "MONO_",
  "LIN_PER_",
  "LIN_",
  "LEUC_",
  "LDH_",
  "INR_",
  "HGB_",
  "HBA1C_",
  "GPT_",
  "GOT_",
  "GLU_",
  "GGT_",
  "FOS_",
  "FA_",
  "DD_",
  "CREA_",
  "CA2_",
  "CA_",
  "BT_",
  "HDL_",
  "COL_")

#"COVID19_PCR_GRUP_LAVADO",

# mirar-ho!!!

dt_plana_covid4_agr2 <-
  vect2%>% 
  map(~dt_spread(dt_plana_covid4_agr,.x)) %>% 
  reduce(full_join,by="PATIENT.ID")

```


```{r agregacio10}
# Abans de passar-ho a número Real, DESCRIPTIU ERRORS!





#1) dades qualit?
dt_plana_covid4_agr2$US_troponina_1             <-as.double(dt_plana_covid4_agr2$US_troponina_1)
#2) ok
dt_plana_covid4_agr2$TP_1             <-as.double(dt_plana_covid4_agr2$TP_1)                    
#3) ok
dt_plana_covid4_agr2$TCO2V_1             <-as.double(dt_plana_covid4_agr2$TCO2V_1)               
#4) dades qualit?
dt_plana_covid4_agr2$TCO2_1          <-as.double(dt_plana_covid4_agr2$TCO2_1)   
#4B) dades qualit?
dt_plana_covid4_agr2$SO2C_1          <-as.double(dt_plana_covid4_agr2$SO2C_1)   
#5) dades qualit?
dt_plana_covid4_agr2$PROCAL_1          <-as.double(dt_plana_covid4_agr2$PROCAL_1)                  
#6) ok
dt_plana_covid4_agr2$PO2V_1          <-as.double(dt_plana_covid4_agr2$PO2V_1)
#7) dades qualit?
dt_plana_covid4_agr2$PO2_1          <-as.double(dt_plana_covid4_agr2$PO2_1)
#8) ok
dt_plana_covid4_agr2$PLAQ_1          <-as.double(dt_plana_covid4_agr2$PLAQ_1)
#9) dades qualit?
dt_plana_covid4_agr2$PCR_1          <-as.double(dt_plana_covid4_agr2$PCR_1)
#10) ok
dt_plana_covid4_agr2$PCO2V_1          <-as.double(dt_plana_covid4_agr2$PCO2V_1)
#11) dades qualit?
dt_plana_covid4_agr2$PCO2_1          <-as.double(dt_plana_covid4_agr2$PCO2_1)
#12 ok
dt_plana_covid4_agr2$NEU_PER_1          <-as.double(dt_plana_covid4_agr2$NEU_PER_1)
#13 ok
dt_plana_covid4_agr2$NEU_1          <-as.double(dt_plana_covid4_agr2$NEU_1)
#14 ok
dt_plana_covid4_agr2$NA_1          <-as.double(dt_plana_covid4_agr2$NA_1)
#15 ok
dt_plana_covid4_agr2$MONO_PER_1          <-as.double(dt_plana_covid4_agr2$MONO_PER_1)
#16 dades qualit?
dt_plana_covid4_agr2$MONO_1          <-as.double(dt_plana_covid4_agr2$MONO_1)
#17 ok
dt_plana_covid4_agr2$LIN_PER_1          <-as.double(dt_plana_covid4_agr2$LIN_PER_1)
#18 dades qualit?
dt_plana_covid4_agr2$LIN_1          <-as.double(dt_plana_covid4_agr2$LIN_1)
#19 ok
dt_plana_covid4_agr2$LEUC_1          <-as.double(dt_plana_covid4_agr2$LEUC_1)
#20 dades qualit?
dt_plana_covid4_agr2$LDH_1          <-as.double(dt_plana_covid4_agr2$LDH_1)
#21 ok
dt_plana_covid4_agr2$INR_1          <-as.double(dt_plana_covid4_agr2$INR_1)
#22 ok
dt_plana_covid4_agr2$HGB_1          <-as.double(dt_plana_covid4_agr2$HGB_1)
#23 ok
dt_plana_covid4_agr2$HBA1C_1          <-as.double(dt_plana_covid4_agr2$HBA1C_1)
#24 dades qualit?
dt_plana_covid4_agr2$GPT_1          <-as.double(dt_plana_covid4_agr2$GPT_1)
#25 ok
dt_plana_covid4_agr2$GOT_1          <-as.double(dt_plana_covid4_agr2$GOT_1)
#26 ok
dt_plana_covid4_agr2$GLU_1          <-as.double(dt_plana_covid4_agr2$GLU_1)
#27 ok
dt_plana_covid4_agr2$GGT_1          <-as.double(dt_plana_covid4_agr2$GGT_1)
#28 dades qualit?
dt_plana_covid4_agr2$FOS_1          <-as.double(dt_plana_covid4_agr2$FOS_1)
#29 ok
dt_plana_covid4_agr2$FA_1          <-as.double(dt_plana_covid4_agr2$FA_1)
#30 dades qualit?
dt_plana_covid4_agr2$DD_1          <-as.double(dt_plana_covid4_agr2$DD_1)
#31
#dt_plana_covid4_agr2$CREA_1          <-as.double(dt_plana_covid4_agr2$CREA_1)
#32 ok
dt_plana_covid4_agr2$CA2_1          <-as.double(dt_plana_covid4_agr2$CA2_1)
#33 ok
dt_plana_covid4_agr2$CA_1          <-as.double(dt_plana_covid4_agr2$CA_1)
#34 dades qualit?
dt_plana_covid4_agr2$BT_1          <-as.double(dt_plana_covid4_agr2$BT_1)
#35 dades qualit?
dt_plana_covid4_agr2$CREA_1         <-as.double(dt_plana_covid4_agr2$CREA_1)
#36 dades qualit?
dt_plana_covid4_agr2$HDL_1          <-as.double(dt_plana_covid4_agr2$HDL_1)
#37 ok
dt_plana_covid4_agr2$COL_1          <-as.double(dt_plana_covid4_agr2$COL_1)
#38
#"G_CORONAV_"


#8.9.2020

#La fórmula del HA1B en mmols es (S'ha de crear una nova variable i la poses a les taules):
# Càlcul de Variable nueva IFCC HbA1c (nmmol/mol) = (10.93*HB1AC)-23.50

dt_plana_covid4_agr2<-dt_plana_covid4_agr2%>%mutate(HA1C_MMOLS1 =((10.93*HBA1C_1) - 23.50))



```


```{r agregacio11}
analitiques.agr2<-agregar_vars_covid2(dt =dt_plana_covid4_agr_B)

# 25.7.2020
AgeSex<-dt_plana_covid1_agr%>%select(PATIENT.ID,EDAD.AGE,SEXO.SEX)
AgeSex$PATIENT.ID<-as.character(AgeSex$PATIENT.ID)
AgeSex<-AgeSex%>%transmute(PATIENT.ID,EDAD.AGE,SEXO.SEX,Ethnicity="non-black")



dt_plana_covid4_agr3<-dt_plana_covid4_agr2 %>%
  left_join(analitiques.agr2  ,by="PATIENT.ID") %>%
     left_join(AgeSex  ,by="PATIENT.ID")%>%
         left_join(dt_plana_covid4_agr_CORONA  ,by="PATIENT.ID")




###################################################################
#Se me había olvidado tb..tenemos que calcular CKD-EPI , con la edad, y los datos de creatinina, 
#Filtrado glomerular = 
#141 × min(Scr/κ , 1)α × 
#max(Scr/κ , 1)−1,209 × 
#0,993edad × 
#1,018 (si es mujer) × 
#1,159 (si es de raza negra)
###################################################################
#Scr : creatinina sérica
#κ : 0,7 si es mujer y 0,9 si es hombre
#α : −0,329 si es mujer y −0,411 si es hombre
#min(Scr/κ , 1) : el valor que sea menor entre Scr/κ y 1
#max(Scr/κ , 1) : el valor que sea mayor entre Scr/κ y 1
###################################################################
# hipòtesis tos blancs, per tant 1.159=1.
  ## Filtrado glomerular:39.91 ml/min/1,73 m²
```


```{r agregacio12}
dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%mutate(sexvar = ifelse(SEXO.SEX == "MALE", 1, 1.018))
dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%mutate(alpha = ifelse(SEXO.SEX == "MALE", -0.411, -0.329))
dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%mutate(kappa = ifelse(SEXO.SEX == "MALE", 0.9, 0.7))
  
dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%mutate(gfr = 141 * ifelse(CREA_1/kappa > 1, 1, CREA_1/kappa)^alpha *
                    ifelse(CREA_1/kappa < 1, 1, CREA_1/kappa)^-1.209 * 0.993^EDAD.AGE *sexvar)
  
dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%mutate(gfr = ifelse(Ethnicity == "black", gfr * 1.159, gfr))




dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%
  mutate_at(vars(starts_with("CORONA") ),funs(ifelse(is.na(.),"No se detecta",.)))




```


```{r agregacio13}
####################################################################
##[T5]##. PROBLEMES DE SALUT!
####################################################################

dt_plana_covid5<-dt_05
dt_plana_covid5_gather<-dt_plana_covid5%>%gather("Problema_salud_Urgencia","CIE10",-PATIENT.ID)%>%
  arrange(PATIENT.ID)

dt_plana_covid6<-dt_06
dt_plana_covid6_gather<-dt_plana_covid6%>%gather("Problema_salud_Ingreso","CIE10",-PATIENT.ID)%>%
  arrange(PATIENT.ID)


dt_plana_covid5_gatherb<-dt_plana_covid5_gather%>% transmute(idp=PATIENT.ID,cod=as.character(CIE10),dat="20200520") 
dt_plana_covid6_gatherb<-dt_plana_covid6_gather%>% transmute(idp=PATIENT.ID,cod=as.character(CIE10),dat="20200520") 


dt_diagnostics<-dt_plana_covid5_gatherb%>%bind_rows(dt_plana_covid6_gatherb)



# AGREGACIÓ:!!!
dt_plana_covid5_6_agr2<-agregar_problemes(select(dt_diagnostics,idp,cod,dat),
                                       bd.dindex = "20000601",
                                       dt.agregadors=select(dt_cataleg2,cod,agr=agr2),
                                       finestra.dies=c(-Inf,Inf),prefix = "DG2.") 

dt_plana_covid5_6_agr<-agregar_problemes(select(dt_diagnostics,idp,cod,dat),
                                          bd.dindex = "20000601",
                                          dt.agregadors=select(dt_cataleg2,cod,agr=agr),
                                          finestra.dies=c(-Inf,Inf),prefix = "DG.")
```


```{r events1}
#############################################################################################
#                   E V E N T S                                                             #
#############################################################################################
#
#
#

#EVENTS!!!!  MOLT IMPORTANT!!  DIAGNOSTICS INGRES!

#fallo renal agudo--> IRA(Event!)
#20200520


dt_diagnostics_INGRES<-dt_plana_covid6_gatherb
dt_plana_covid_INGRES_agr<-agregar_problemes(select(dt_diagnostics_INGRES,idp,cod,dat),
                                         bd.dindex = "20000601",
                                         dt.agregadors=select(dt_cataleg2,cod,agr=agr),
                                         finestra.dies=c(-Inf,Inf),prefix = "EV1.") 

dt_plana_covid_INGRES_agr2<-agregar_problemes(select(dt_diagnostics_INGRES,idp,cod,dat),
                                             bd.dindex = "20000601",
                                             dt.agregadors=select(dt_cataleg2,cod,agr=agr2),
                                             finestra.dies=c(-Inf,Inf),prefix = "EV2.") 

dt_plana_covid_INGRES_agr3<-agregar_problemes(select(dt_diagnostics_INGRES,idp,cod,dat),
                                              bd.dindex = "20000601",
                                              dt.agregadors=select(dt_cataleg2,cod,agr=agr7),
                                              finestra.dies=c(-Inf,Inf),prefix = "EV3.") 



#-------------------------------------------------#
#variable.names(dt_plana_covid_INGRES_agr)
#1,775 x 102

#DG.SDRA   
#DG.TEP
#DG.COMP_NEURO                             
#DG.ENCEFALITIS                          
#DG.Mechanical_ventialtion                              
#DG.TVP

#variable.names(dt_plana_covid_INGRES_agr2)
#1,775 x 29
#DG.COMP_NEUMO             

#variable.names(dt_plana_covid_INGRES_agr3)

dt_plana_covid_INGRES_agr<-dt_plana_covid_INGRES_agr %>%select(idp,
                                                               EV1.SDRA,
                                                               EV1.TEP,
                                                               EV1.COMP_NEURO ,
                                                               EV1.ENCEFALITIS  ,
                                                               EV1.Mechanical_ventialtion,
                                                               EV1.TVP,
                                                               EV1.IRA)

dt_plana_covid_INGRES_agr2<-dt_plana_covid_INGRES_agr2 %>%select(idp,EV2.COMP_NEUMO)
dt_plana_covid_INGRES_agr3<-dt_plana_covid_INGRES_agr3 %>%select(idp,
                                                                 EV3.VENT1,
                                                                 EV3.VENT3,
                                                                 EV3.VENT4,
                                                                 EV3.VENT5,
                                                                 EV3.VENT6,
                                                                 EV3.VENT7,
                                                                 EV3.VENT8,
                                                                 EV3.VENT9,
                                                                 EV3.VENT10)
```



```{r diabetics1}
#############################################################################################
#                   B U S C A R     D I A B E T I C S                                              

#----------------------------------------------------------------------------#
#[20.07.2020]   ULL!!! MOLT IMPORTANT!
#----------------------------------------------------------------------------#
#----------------------------------------------------------------------------#
#                                 busquem els diàbetics:
#----------------------------------------------------------------------------#


CATAL<-readxl::read_excel(conductor_codis2,col_types = "text")%>%select(cod,agr5)%>%filter(agr5=="DM")
CATAL_INSU<-readxl::read_excel(conductor_codis2,col_types = "text")%>%select(cod,agr6)%>%filter(agr6=="INSU")
#----------------------------------------------------------------------------#
#                          DM--> PROBLEMES     [dt_plana_covid5_gather +dt_plana_covid6_gather] 
#                          DM--> FARMACS       [dt_plana_covid2B]
#                          DM--> LABORATORI    [dt_plana_covid4_agr] MAX HbA1c>=6.5%                          
#----------------------------------------------------------------------------#
#
#----------------------------------------------------------------------------#
#                          DM--> PROBLEMES     [dt_plana_covid5_gather +dt_plana_covid6_gather] 
#----------------------------------------------------------------------------#
#Registros de la codificación de la urgencia,según la CIE10   
#dt_plana_covid5_gather
#Registros de la codificación del ingreso,según la CIE10 
#dt_plana_covid6_gather
#----------------------------------------------------------------------------#

#variable.names(dt_plana_covid5_gather)
#[1] "PATIENT.ID"              "Problema_salud_Urgencia" "CIE10"   
#variable.names(dt_plana_covid6_gather)
#[1] "PATIENT.ID"             "Problema_salud_Ingreso" "CIE10"          
#----------------------------------------------------------------------------#
dt_plana_covid5_gather2<-dt_plana_covid5_gather%>% transmute(idp=PATIENT.ID,cod=CIE10,dat="20200520")
dt_plana_covid6_gather2<-dt_plana_covid6_gather%>% transmute(idp=PATIENT.ID,cod=CIE10,dat="20200520")
# Fusiono dt_PROBLEMES (dt_plana_covid5_gather +dt_plana_covid6_gather )
dt_plana_covid56_gather2<-dt_plana_covid5_gather2%>%bind_rows(dt_plana_covid6_gather2)%>%arrange(idp)
#----------------------------------------------------------------------------#
dt_plana_DM_agr1<-agregar_problemes(select(dt_plana_covid56_gather2,idp,cod,dat),
                                    bd.dindex = "20000601",
                                    dt.agregadors=select(dt_cataleg2,cod,agr=agr5),
                                    finestra.dies=c(-Inf,Inf),prefix = "DM.") 
#----------------------------------------------------------------------------#
#dt_plana_DM_agr1
#----------------------------------------------------------------------------#
GRUP1<-dt_plana_covid56_gather2%>%inner_join(dt_plana_DM_agr1,by="idp")%>%select(idp,cod)
GRUP1<-GRUP1%>%inner_join(CATAL,by="cod")
#----------------------------------------------------------------------------#
```


```{r diabetics2}
##[T2]##.Farmacs.Mètode:Aggregador.
#dt_plana_covid2
dt_plana_covid2B<-dt_plana_covid2%>% transmute(idp=PATIENT.ID,cod=as.character(ID_ATC7),dat="20200520") 
#variable.names(dt_plana_covid2)
#[1] "PATIENT.ID"                                   "FARMACO.DRUG_NOMBRE_COMERCIAL.COMERCIAL_NAME"
#[3] "DOSIS_MEDIA_DIARIA.DAILY_AVRG_DOSE"           "INICIO_TRAT.DRUG_START_DATE"                 
#[5] "FIN_TRAT.DRUG_END_DATE"                       "ATC5_NOMBRE.NAME"                            
#[7] "ID_ATC5"                                      "ATC7_NOMBRE.NAME"                            
#[9] "ID_ATC7"                                     
#----------------------------------------------------------------------------#
dt_plana_DM_agr2<-agregar_problemes(select(dt_plana_covid2B,idp,cod,dat),
                                    bd.dindex = "20000601",
                                    dt.agregadors=select(dt_cataleg2,cod,agr=agr5),
                                    finestra.dies=c(-Inf,Inf),prefix = "DM.") 
#----------------------------------------------------------------------------#
GRUP2<-dt_plana_covid2B%>%inner_join(dt_plana_DM_agr2,by="idp")%>%select(idp,cod)
GRUP2<-GRUP2%>%inner_join(CATAL,by="cod")
#----------------------------------------------------------------------------#
```


```{r diabetics3}
# Agrego per CIP I agafo la última situació 
#dt_demografiques<-dt_demografiques %>% 
#  transmute(CIP,sexe,situacio,dNaixement=lubridate::ymd(dNaixement),ABS,dsituacio=lubridate::ymd(dsituacio)) %>% 
#  group_by(CIP) %>% dplyr::slice(which.max(dsituacio)) %>% ungroup()


#                          DM--> LABORATORI    [dt_plana_covid4_agr] MAX HbA1c>=6.5%      


#


#dt_plana_DM_agr3                   <-dt_plana_covid4_agr
#dt_plana_DM_agr3$valor             <-as.double(dt_plana_DM_agr3$valor)
#dt_plana_DM_agr3<-dt_plana_DM_agr3%>% filter(cod=="HBA1C_" & valor >=6.5 )


dt_plana_DM_agr3                   <-dt_plana_covid4_agr_B
dt_plana_DM_agr3$valor             <-as.double(dt_plana_DM_agr3$valor)
dt_plana_DM_agr3<-dt_plana_DM_agr3%>% filter(cod=="HBA1C_" & valor >=6.5 )
GRUP3<-dt_plana_DM_agr3%>%select(PATIENT.ID,valor, cod)
dt_plana_DM_agr3<-dt_plana_DM_agr3%>% transmute(idp=PATIENT.ID,dtindex="20000601", DM.DM="20200520")
dt_plana_DM_agr3$idp<-as.numeric(dt_plana_DM_agr3$idp)


DIA_INDEX<-dt_01%>%transmute(idp=PATIENT.ID,DIA.INDEX=F_INGRESO.ADMISSION_D_ING.INPAT)
DIA_INDEX$DIA.INDEX<-as.character(DIA_INDEX$DIA.INDEX)
#DIA_INDEX
#----------------------------------------------------------------------------#
DIA_INDEX$DIA<-substr(DIA_INDEX$DIA.INDEX,1,2)
DIA_INDEX$MES<-substr(DIA_INDEX$DIA.INDEX,4,5)
DIA_INDEX$ANY<-substr(DIA_INDEX$DIA.INDEX,7,10)
#----------------------------------------------------------------------------#
DIA_INDEX$DIA.INDEX2<-paste0(DIA_INDEX$ANY,DIA_INDEX$MES,DIA_INDEX$DIA)
#----------------------------------------------------------------------------#

#----------------------------------------------------------------------------#
DIA_INDEX<-DIA_INDEX%>%select(idp,DIA.INDEX2)
#----------------------------------------------------------------------------#


#----------------------------------------------------------------------------#
DIA_INDEX2<-dt_02

DIA_INDEX2$INICIO_TRAT.DRUG_START_DATE<-as.Date(DIA_INDEX2$INICIO_TRAT.DRUG_START_DATE,"%d/%m/%Y")
DIA_INDEX2<-DIA_INDEX2%>% transmute(idp=PATIENT.ID,cod=as.character(ID_ATC7),dat=INICIO_TRAT.DRUG_START_DATE) 
#----------------------------------------------------------------------------#
DIA_INDEX2$ANY<-substr(DIA_INDEX2$dat,1,4)
DIA_INDEX2$MES<-substr(DIA_INDEX2$dat,6,7)
DIA_INDEX2$DIA<-substr(DIA_INDEX2$dat,9,10)
#----------------------------------------------------------------------------#
DIA_INDEX2$dat2<-paste0(DIA_INDEX2$ANY,DIA_INDEX2$MES,DIA_INDEX2$DIA)
DIA_INDEX2<-DIA_INDEX2%>%transmute(idp,cod,dat=dat2)
#----------------------------------------------------------------------------#
dt_plana_DM_agr4<-agregar_problemes(select(DIA_INDEX2,idp,cod,dat),
                                    bd.dindex =DIA_INDEX,
                                    dt.agregadors=select(dt_cataleg2,cod,agr=agr6),
                                    finestra.dies=c(0,1),prefix = "Far.") 

dt_plana_DM_agr4<-dt_plana_DM_agr4%>%transmute(idp,dtindex,DG.DM=Far.INSU)


#-------------------------------------------------------#
#dt_plana_DM_agr4
#-------------------------------------------------------#
GRUP4<-DIA_INDEX2%>%inner_join(dt_plana_DM_agr4,by="idp")%>%inner_join(CATAL_INSU,by="cod")
#
#GRUP1
#GRUP2
#GRUP3
#GRUP4
#-----------------------------------------------------------------------------------------------------#
```


```{r diabetics4}
#-------------------------------------------------------#
dt_plana_DM_agr5<-dt_plana_covid4_agr3%>%select(PATIENT.ID,max_pacient_valor_GLU_)
GRUP5<-dt_plana_DM_agr5%>% filter(max_pacient_valor_GLU_>=200 )
dt_plana_DM_agr5<-dt_plana_DM_agr5%>% filter(max_pacient_valor_GLU_>=200 )
dt_plana_DM_agr5<-dt_plana_DM_agr5%>%transmute(idp=PATIENT.ID)
dt_plana_DM_agr5$idp<-as.numeric(dt_plana_DM_agr5$idp)
#-------------------------------------------------------#


#table(dt_plana_DM_agr1$idp)
#table(dt_plana_DM_agr2$idp)
#table(dt_plana_DM_agr3$idp)
#table(dt_plana_DM_agr4$idp)
#table(dt_plana_DM_agr5$idp)


#-----------------------------------------------------------------------------------------------------#
C_DIABETICS<-dt_plana_DM_agr1%>%
  bind_rows(dt_plana_DM_agr2)%>%
  bind_rows(dt_plana_DM_agr3)%>%
  bind_rows(dt_plana_DM_agr4)%>%
  bind_rows(dt_plana_DM_agr5)%>%
  arrange(idp)%>%
  group_by(idp)%>% slice(1) %>% ungroup() %>%select(idp)



#table(C_DIABETICS$idp)
#-----------------------------------------------------------------------------------------------------#
C_NO_DIABETICS<-dt_plana_covid1_agr %>% transmute(idp=PATIENT.ID)%>% anti_join(C_DIABETICS,by="idp")
#-----------------------------------------------------------------------------------------------------#




```

```{r taulaPlana}
#-----------------------------------------------------------------------------------------------------#
# 15.9.2020  TAULA PLANA!!!
#-----------------------------------------------------------------------------------------------------#


#Taula Principal.T.PLANA!#
#dt_plana_covid1_agr
#(PATIENT.ID)--><dbl> 

#Medicació Ingrés.T.PLANA!#
#dt_plana_covid2_agr
#dt_plana_covid2_agr_b
#(idp)--><int>


dt_plana_covid2_agr<-dt_plana_covid2_agr%>% mutate(PATIENT.ID=idp)
dt_plana_covid2_agr$PATIENT.ID<-as.double(dt_plana_covid2_agr$PATIENT.ID)
dt_plana_covid2_agr_b<-dt_plana_covid2_agr_b%>% mutate(PATIENT.ID=idp)
dt_plana_covid2_agr_b$PATIENT.ID<-as.double(dt_plana_covid2_agr_b$PATIENT.ID)


#Constants Vitals Ingrés.T.PLANA!#
#dt_plana_covid3_agr
#(PATIENT.ID)=--><int>
dt_plana_covid3_agr$PATIENT.ID<-as.double(dt_plana_covid3_agr$PATIENT.ID)


#Determinacions T.Plana!
#dt_plana_covid4_agr3
#(PATIENT.ID)--><dbl> 
dt_plana_covid4_agr3$PATIENT.ID<-as.double(dt_plana_covid4_agr3$PATIENT.ID)


#Problemes de salut Ingrés/Urgència.T.PLANA!#
#dt_plana_covid5_6_agr
#dt_plana_covid5_6_agr2
#(PATIENT.ID)--><dbl> 



dt_plana_covid5_6_agr<-dt_plana_covid5_6_agr%>% mutate(PATIENT.ID=idp)
dt_plana_covid5_6_agr$PATIENT.ID<-as.double(dt_plana_covid5_6_agr$PATIENT.ID)

dt_plana_covid5_6_agr2<-dt_plana_covid5_6_agr2%>% mutate(PATIENT.ID=idp)
dt_plana_covid5_6_agr2$PATIENT.ID<-as.double(dt_plana_covid5_6_agr2$PATIENT.ID)



#Grup de Diabètics.T.PLANA!#
#C_DIABETICS
#(PATIENT.ID)--><dbl> 

C_DIABETICS<-C_DIABETICS%>%transmute(PATIENT.ID=idp,G_DIABETIC=1)
C_DIABETICS$PATIENT.ID<-as.double(C_DIABETICS$PATIENT.ID)


#Events que volem.T.PLANA!#
#dt_plana_covid_INGRES_agr
#(PATIENT.ID)--><dbl> 



#variable.names(dt_plana_covid1_agr)
#[1] "PATIENT.ID"                                 "EDAD.AGE"                                  
#[3] "SEXO.SEX"                                   "DIAG.ING.INPAT"                            
#[5] "F_INGRESO.ADMISSION_D_ING.INPAT"            "F_ENTRADA_UC.ICU_DATE_IN"                  
#[7] "F_SALIDA_UCI.ICU_DATE_OUT"                  "UCI_DIAS.ICU_DAYS"                         
#[9] "F_ALTA.DISCHARGE_DATE_ING"                  "MOTIVO_ALTA.DESTINY_DISCHARGE_ING"         
#[11] "F_INGRESO.ADMISSION_DATE_URG.EMERG"         "HORA.TIME_ADMISION.ADMISSION_URG.EMERG"    
#[13] "ESPECIALIDAD.DEPARTMENT_URG.EMERG"          "DIAG_URG.EMERG"                            
#[15] "DESTINO.DESTINY_URG.EMERG"                  "HORA.TIME_CONSTANT_PRIMERA.FIRST_URG.EMERG"
#[17] "TEMP_PRIMERA.FIRST_URG.EMERG"               "FC.HR_PRIMERA.FIRST_URG.EMERG"             
#[19] "GLU_PRIMERA.FIRST_URG.EMERG"                "SAT_02_PRIMERA.FIRST_URG.EMERG"            
#[21] "TA_MAX_PRIMERA.FIRST.EMERG_URG"             "TA_MIN_PRIMERA.FIRST_URG.EMERG"            
#[23] "HORA.TIME_CONSTANT_ULTIMA.LAST_URG.EMERG"   "FC.HR_ULTIMA.LAST_URG.EMERG"               
#[25] "TEMP_ULTIMA.LAST_URG.EMERG"                 "GLU_ULTIMA.LAST_URG.EMERG"                 
#[27] "SAT_02_ULTIMA.LAST_URG.EMERG"               "TA_MAX_ULTIMA.LAST_URGEMERG"               
#[29] "TA_MIN_ULTIMA.LAST_URG.EMERG"               "year_ingres"                               
#[31] "year_urg"                                   "URG"         

#variable.names(dt_plana_covid2_agr)
#[1] ###"idp"              ###"dtindex"          "FX.ANESTETICOS"    "FX.ANT_FUNG"       "FX.ANTI_AGG"       
#[6]  "FX.ANTI_anem"      "FX.ANTI_DIAR"           "FX.ANTI_DOL"       "FX.ANTI_DOL_TOP"   "FX.ANTI_EMET"      
#[11] "FX.ANTI_EPILEP"    "FX.ANTI_FUN_ESTO" 
#[11] "FX.ANTI_GOTA"      "FX.ANTI_hem"       "FX.ANTI_HIPOLIP"   "FX.ANTI_HIS"       "FX.ANTI_HTA"      
#[16] "FX.ANTI_NEO"       "FX.ANTI_PARC"      "FX.ANTI_PSIC_O"    "FX.ANTI_TIRO"      "FX.ANTI_TROMB"    
#[21] "FX.ANTI_TUS"       "FX.ANTI_ULCE"      "FX.ANTI_VIR"       "FX.Antiacidos"     "FX.ANTIBIO"       
#[26] "FX.ANTIBIO_DERM"   "FX.Antidotos"      "FX.ANTIINF_ANTIRE" "FX.ANTIINF_OCUL"   "FX.ANTIMICO"      
#[31] "FX.ANTIPROTO"      "FX.ANTISEPT"       "FX.ANTITBC"        "FX.APOSITOS"       "FX.Biguanidas"    
#[36] "FX.BRONCO_DIL"     "FX.Calcio"         "FX.CORTICO_DERM"   "FX.CORTIS"         "FX.DIGE"          
#[41] "FX.EMOLIENTES"     "FX.GINE"           "FX.Glucagon"       "FX.HORM_Ca"        "FX.HORM_HIPO"     
#[46] "FX.HORM_SEX"       "FX.IDPP4"          "FX.INMUNO_STIM"    "FX.INMUNO_SUPR"    "FX.INSULINAS_INTM"
#[51] "FX.INSULINAS_LENT" "FX.INSULINAS_Rap"  "FX.Laxantes"       "FX.MAGNESIO"       "FX.OTRO_NEUR"     
#[56] "FX.OTRO_SUP"       "FX.OTRO_VIT"       "FX.OTROS"          "FX.POTASIO"        "FX.PSICOANALEP"   
#[61] "FX.PSICOLEP"       "FX.REL_MUSC"       "FX.STOMAT_PREP"    "FX.Sulfonilureas"  "FX.SUST_Plasma"   
#[66] "FX.TER_BILIAR"     "FX.TER_CARD"       "FX.TER_hormon"     "FX.URO"            "FX.VASO_DILA"     
#[71] "FX.VASO_PROT"      "FX.VIT_D"          "PATIENT.ID"          
dt_plana_covid2_agr<-dt_plana_covid2_agr%>%select(-idp,-dtindex)

#variable.names(dt_plana_covid2_agr_b)
#[1] ###"idp"                                              ###"dtindex"
#[3] "FX.Agents_acting_on_the_renin_angiotensin_system" "FX.Beta_blocking_agents"                         
#[5] "FX.Bile_acid_sequestrants"                        "FX.Calcium_channel_blockers"                     
#[7] "FX.Diuretics"                                     "FX.HMG_CoA_reductase_inhibitors"                 
#[9] "FX.Other_lipid_modifying_agents"                  "PATIENT.ID"                    
dt_plana_covid2_ag_b<-dt_plana_covid2_agr_b%>%select(-idp,-dtindex)



#variable.names(dt_plana_covid3_agr)
#variable.names(dt_plana_covid4_agr3)
dt_plana_covid4_agr3<-dt_plana_covid4_agr3%>%select(-EDAD.AGE,-SEXO.SEX)


#variable.names(dt_plana_covid5_6_agr)
#[1] ###"idp"                     ###"dtindex"                "DG.ABCESO_PULMO"          
#[4] "DG.AFASIA"                 "DG.Albuminuria"             "DG.ALERGIA"               
#[7] "DG.ANEMIAS"                "DG.APENDICITIS"             "DG.APNEA"                 
#[10] "DG.ARRITMIA"               "DG.ARTER_PER"              "DG.ARTERITIS"             
#[13] "DG.Asma"                   "DG.ASMA"                   "DG.ASTENIA"               
#[16] "DG.ATELECTASIA"            "DG.AVC"                    "DG.CARD_ISQ"              
#[19] "DG.CARDIOPATÍA"            "DG.CEFALEA"                "DG.CELULITIS"             
#[22] "DG.COAGULOPATÍA"           "DG.COMP_NEURO"             "DG.Demencia"              
#[25] "DG.DEMENCIA"               "DG.Depresion"              "DG.DESORIENTACION"        
#[28] "DG.Diarrea"                "DG.DISNEA"                 "DG.DISPEPSIA"             
#[31] "DG.DIVERTICULAR"           "DG.DM"                     "DG.DM_SEC"                
#[34] "DG.DM1"                    "DG.DM2"                    "DG.DOLOR"                 
#[37] "DG.DOLOR ABDOMINAL"        "DG.DOLOR TORACICO"         "DG.EMBA"                  
#[40] "DG.ENCEFALITIS"            "DG.ENF_APA_MUS"            "DG.ENF_AUTOIN"            
#[43] "DG.ENF_BAC_OTR"            "DG.ENF_HEP"                "DG.ENF_INF_OTR"           
#[46] "DG.ENF_MUSC"               "DG.ENF_RES_OTRA"           "DG.EPOC_ENFISEMA"         
#[49] "DG.ESTREÑIMIENTO"          "DG.EXANTEMA"               "DG.FIEBRE"                
#[52] "DG.FRACTURA"               "DG.GASTRITIS"              "DG.GASTROENTERITIS"       
#[55] "DG.HEMATURIA"              "DG.HEMORRAGIA_DIGEST"      "DG.HERNIA"                
#[58] "DG.HIPOTENSION"            "DG.HIPOTIROIDISMO"         "DG.HTA"                   
#[61] "DG.Hyperlip"               "DG.INF_CUT"                "DG.INFEC_CUT"             
#[64] "DG.INFEC_URI"              "DG.INFECCION"              "DG.INMUNO_DEF"            
#[67] "DG.INSUF_CARD"             "DG.INSUF_RESP"             "DG.INSUF_RESPI"           
#[70] "DG.INTERSTICIAL"           "DG.INTESTINAL"             "DG.IRA"                   
#[73] "DG.IRC"                    "DG.IRVA"                   "DG.IRVB"                  
#[76] "DG.LITIASIS VESICULA"      "DG.MARCHA"                 "DG.Mechanical_ventialtion"
#[79] "DG.MEG"                    "DG.MIASTENIA"              "DG.Micosis"               
#[82] "DG.MIOCARDITIS"            "DG.Neoplasia"              "DG.NEUMONIA"              
#[85] "DG.NEUMONIA_NOC"           "DG.NEUMONITIS"             "DG.NO"                    
#[88] "DG.OB"                     "DG.OTRO"                   "DG.OTRO_TRAS_HEMA"        
#[91] "DG.OTRO_TRAS_NERV"         "DG.Pancreatitis"           "DG.PARESTESIAS"           
#[94] "DG.PARO"                   "DG.PERICARDIO"             "DG.PERINATAL"             
#[97] "DG.PLEURAL"                "DG.REAC_FARMA"             "DG.SDRA"                  
#[100] "DG.SIN_SIG_RES"            "DG.TCE"                    "DG.TEP"                   
#[103] "DG.TOS"                    "DG.TRAST_MENTAL"           "DG.TRAST_META"            
#[106] "DG.TRAUMATISMO"            "DG.TVP"                    "DG.ULCERA"                
#[109] "DG.ULCUS"                  "DG.URTICARIA"              "DG.UTICARIA"              
#[112] "DG.VALVULOPATÍA"           "DG.vertigo"                "DG.VIH"                   
#[115] "DG.Vomitos"                "PATIENT.ID"               
dt_plana_covid5_6_agr<-dt_plana_covid5_6_agr%>%select(-idp,-dtindex)



#variable.names(dt_plana_covid5_6_agr2)
#[1] ###"idp"                       ###"dtindex"              "DG.COMP_CARDIO"           
#[4]  "DG.COMP_CARDIOVASC"        "DG.COMP_COAGU"             "DG.COMP_COT"              
#[7]  "DG.COMP_CUTAN"             "DG.COMP_END"               "DG.COMP_GENITOU"          
#[10] "DG.COMP_HEMATO"            "DG.COMP_NEUMO"             "DG.COMP_NEURO"            
#[13] "DG.DM"                     "DG.ENF_APA_DIG"            "DG.ENF_APA_MUS"           
#[16] "DG.ENF_AUTOIN"             "DG.ENF_MUSC"               "DG.FIEBRE"                
#[19] "DG.HTA"                    "DG.Hyperlip"               "DG.INFECCION"             
#[22] "DG.INSUF_CARD"             "DG.MATERNO_FETAL"          "DG.Mechanical_ventialtion"
#[25] "DG.Neoplasia"              "DG.OB"                     "DG.OTROS"                 
#[28] "DG.TRAST_MENTAL"           "DG.TRAST_METABOL"          "PATIENT.ID"               
dt_plana_covid5_6_agr2<-dt_plana_covid5_6_agr2%>%select(-idp,-dtindex)



#variable.names(dt_plana_covid_INGRES_agr)
#[1] "EV1.SDRA"                   "EV1.TEP"                    "EV1.COMP_NEURO"            
#[4] "EV1.ENCEFALITIS"            "EV1.Mechanical_ventialtion" "EV1.TVP"                   
#[7] "PATIENT.ID"                 "Neurologic_Comp"            "EV2.COMP_NEUMO"            
#[10] "EV3.VENT1"                  "EV3.VENT3"                  "EV3.VENT4"                 
#[13] "EV3.VENT5"                  "EV3.VENT6"                  "EV3.VENT7"                 
#[16] "EV3.VENT8"                  "EV3.VENT9"                  "EV3.VENT10" 

#variable.names(C_DIABETICS)




 

dt_plana_covid_INGRES_agr <-dt_plana_covid_INGRES_agr%>%mutate(PATIENT.ID=idp)%>% select(-idp)
dt_plana_covid_INGRES_agr2<-dt_plana_covid_INGRES_agr2%>%mutate(PATIENT.ID=idp)%>% select(-idp)
dt_plana_covid_INGRES_agr3<-dt_plana_covid_INGRES_agr3%>%mutate(PATIENT.ID=idp)%>% select(-idp)


```

## 3. Fusió de dades
```{r fusio_taulaPlana}


#-------------------------------------------------------------------------------------------------#
TAULA_PLANA<- dt_plana_covid1_agr%>%left_join(dt_plana_covid2_agr,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid2_agr_b,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid3_agr,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid4_agr3,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid5_6_agr,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid5_6_agr2,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid_INGRES_agr,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid_INGRES_agr2,by="PATIENT.ID")%>%
                                 left_join(dt_plana_covid_INGRES_agr3,by="PATIENT.ID")%>%
                                 left_join(C_DIABETICS,by="PATIENT.ID")



#variable.names(TAULA_PLANA)

TAULA_PLANA<-TAULA_PLANA%>%filter(PATIENT.ID!="577")
TAULA_PLANA           <-TAULA_PLANA%>%arrange(PATIENT.ID)


```


## 4. Salvar taula plana 
```{r salvar}


##save(dt_plana_covid1_org,
##     dt_plana_covid1_agr,
##     dt_plana_covid2_agr2,
##     dt_plana_covid2_agr_b_2,
##     dt_plana_covid3_agr2,
##     dt_plana_covid4_agr3,
##     dt_plana_covid5_6_agr,
##     dt_plana_covid5_6_agr2,
##     dt_plana_covid_INGRES_agr,
##     C_DIABETICS,
##     C_NO_DIABETICS
##     ,file=here::here("COVID2.Rdata"))

save(TAULA_PLANA
     ,file=here::here("COVID2.Rdata"))


```


